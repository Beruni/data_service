"use strict";var express=require("express");var bodyParser=require("body-parser");var multer=require("multer");var mongoose=require("mongoose");var gridfs=require("gridfs-stream");var fs=require("fs");var models_1=require("./models");var JSONStream=require("JSONStream");var jsonwebtoken_1=require("jsonwebtoken");var app=express();app.set("port",process.env.PORT||"3002");app.set("mongo_host",process.env.MONGO_PORT_27017_TCP_ADDR||"localhost");app.use(bodyParser.json());app.use(function(req,res,next){res.header("Access-Control-Allow-Origin","*");res.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, X-Auth-Token, authorization");res.header("Access-Control-Allow-Methods","GET, POST, OPTIONS");res.header("Access-Control-Allow-Credentials","authorization");next()});var uploadConfig=multer({dest:"./uploads"});app.post("/upload",uploadConfig.single("dataFile"),function(req,res){var user=jsonwebtoken_1.decode(req.headers["authorization"]);var gfs=gridfs(mongoose.connection.db,mongoose.mongo);var writeStream=gfs.createWriteStream();var readStream=fs.createReadStream(req.file.path).pipe(JSONStream.parse(""));readStream.on("close",function(){fs.createReadStream(req.file.path).pipe(writeStream)});readStream.on("error",function(e){return res.status(406).send("Invalid JSON!")});writeStream.on("close",function(file){var tags=req.body.tags.split(",");(new models_1.DataFile).save(user["id"],req.body.title,tags,file._id).then(function(dataFileId){return res.status(200).send({fileId:dataFileId})})});writeStream.on("error",function(e){return res.status(500).send("Could not upload file")})});app.get("/fetchFiles",function(request,response){var user=jsonwebtoken_1.decode(request.headers["authorization"]);(new models_1.DataFile).fetch(user.id,function(files){response.end(JSON.stringify(files))})});app.get("/ping",function(req,res){res.end("pong")});mongoose.connect("mongodb://"+app.get("mongo_host")+"/beruni_data_files");app.listen(app.get("port"));
//# sourceMappingURL=./dist/js/src/app.js.map